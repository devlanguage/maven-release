# @(#)file      README
# @(#)author    Sun Microsystems, Inc.
# @(#)version   1.12
# @(#)lastedit  04/05/11
#
# Copyright 2004 Sun Microsystems, Inc. All rights reserved.
# SUN PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.


                            HearBeat Example
                            ================


-----------------------------------------------------------------------
1. Overview
-----------------------------------------------------------------------

This example shows how to implement a simple manager application that uses
the heartbeat mechanism implemented in the connectors provided by Java DMK.

The manager in this example configures the heartbeat parameters (period and
number of retries) and registers as a listener for heartbeat notifications.


-----------------------------------------------------------------------
2. File List
-----------------------------------------------------------------------

This example is based on the following source files:

 * Agent.java:

    - Creates an MBean server
    - Creates, registers and starts an RMI connector server in the MBean server

 * Client.java:

    - Creates an RMI connector client
    - Sets the heartbeat period and the number of retries
    - Adds this manager as a listener for heartbeat notifications
    - Creates an RmiConnectorAddress object
      (default: host = localhost, port = 1099)
    - Connects the RMI connector client to the RMI connector server
      of the Java DMK agent


-----------------------------------------------------------------------
3. Building and Running the Example
-----------------------------------------------------------------------

To build and run this example, make sure that your PATH environment variable
is correctly set to use the Java 2 SDK, Standard Edition 1.4 or later.

On J2SE 1.4, your CLASSPATH must contain the jar files for the JMX runtime
(jmx.jar) and the Java DMK runtime (jdmkrt.jar), as well as the current
directory (.).

On J2SE 1.5, your CLASSPATH must contain the jar files for the Java DMK
runtime (jdmkrt.jar), as well as the current directory (.).

These instructions assume the classpath is set in an environment variable,
though it may also be given on the command line with the -classpath option.

Copy the example source files to your working directory and type the following
commands:

    cd <WORKING_DIR>

    javac *.java

This example must be run in three different ways because it is used
to show different aspects of the heartbeat mechanism.

To run the example using the classes you have just built, type the
following commands in two different shell windows:

-----
RUN 1
-----

To run the agent,

    java Agent

To run the manager,

    java Client

or

    java Client host port

if the agent and manager applications run on different machines.

1) In the client window, the manager should receive a heartbeat connection
   established notification

2) Press the Enter key, the manager should receive a heartbeat connection
   terminated notification as the connector client has disconnected.

3) Type CTRL-C in the agent's window in order to terminate the agent.

This example shows how a manager is notified each time a connector client
is connected to or disconnected from a connector server.

-----
RUN 2
-----

To run the agent,

    java Agent

To run the manager,

    java Client

or

    java Client host port

if the agent and manager applications run on different machines.

1) In the client window, the manager should receive a heartbeat connection
   established notification

2) Type CTRL-C in the agent window in order to terminate the agent.

3) In the client window, the manager should receive a heartbeat connection
   retrying notification indicating that a problem in the connection has
   been encountered and the client is retrying.

4) After two more seconds the manager should receive a heartbeat connection lost
   notification indicating that the retrying failed, that is, the agent died.

5) The manager should receive a heartbeat connection terminated notification as
   the connector client has disconnected because the agent was unreachable.

6) Press the Enter key, the manager should stop running.

This example is a simulation of an agent crash and shows how a manager is
notified when the client loses connection with the server after several retries.

-----
RUN 3
-----

To run the agent,

    java -Djava.util.logging.config.file=logging.properties Agent

To run the manager,

    java Client

or

    java Client host port

if the agent and manager applications run on different machines.

1) In the client window, the manager should receive a heartbeat connection
   established notification

2) Type CTRL-C in the client window in order to terminate the manager.

3) After three and a half seconds, timeout elapses in agent side, and the
   traces will display the messages indicating that the connector client
   died and the agent did the cleanup for that specific connector client.

4) Type CTRL-C in the agent window in order to terminate the agent.

This example is a simulation of a client crash and shows how an agent detects
it and cleans up all the resources allocated by the specific connector client.
